@using PazarAtlasi.CMS.Models.ViewModels
@model PazarAtlasi.CMS.Application.Dtos.SectionItemUpdateDto

@{
    ViewData["Title"] = "Create Section Item";
    var availableLanguages = ViewBag.AvailableLanguages as List<LanguageViewModel>;
}

<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-plus text-blue-600 mr-3 text-xl"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Create New Section Item</h1>
                </div>
            </div>

            <div class="p-6">
                <!-- Error Message -->
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-center">
                        <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                        <span class="text-red-800">@TempData["ErrorMessage"]</span>
                        <button type="button" class="ml-auto text-red-600 hover:text-red-800"
                            onclick="this.parentElement.style.display='none'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                }

                <form asp-action="SectionItemCreate" method="post" class="space-y-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Basic Information -->
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900">Basic Information</h3>
                            </div>
                            <div class="p-6 space-y-6">
                                <div>
                                    <label asp-for="Type" class="block text-sm font-medium text-gray-700 mb-2">
                                        Type <span class="text-red-500">*</span>
                                    </label>
                                    <select asp-for="Type"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                        asp-items="@(new SelectList(ViewBag.SectionItemTypes))" required>
                                        <option value="">Select Type</option>
                                    </select>
                                    <span asp-validation-for="Type" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="MediaType" class="block text-sm font-medium text-gray-700 mb-2">
                                        Media Type <span class="text-red-500">*</span>
                                    </label>
                                    <select asp-for="MediaType"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                        asp-items="@(new SelectList(ViewBag.MediaTypes))" required>
                                        <option value="">Select Media Type</option>
                                    </select>
                                    <span asp-validation-for="MediaType" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="TemplateId"
                                        class="block text-sm font-medium text-gray-700 mb-2">Template</label>
                                    <select asp-for="TemplateId"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">No Template</option>
                                        @foreach (var template in ViewBag.Templates)
                                        {
                                            <option value="@template.Id">
                                                @(template.Translations.FirstOrDefault()?.Name ?? template.TemplateKey)
                                            </option>
                                        }
                                    </select>
                                    <p class="mt-1 text-sm text-gray-500">Select a template to inherit field definitions
                                    </p>
                                    <span asp-validation-for="TemplateId" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="ParentSectionItemId"
                                        class="block text-sm font-medium text-gray-700 mb-2">Parent Section Item</label>
                                    <select asp-for="ParentSectionItemId"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">No Parent (Root Item)</option>
                                        @foreach (var parentItem in ViewBag.ParentSectionItems)
                                        {
                                            <option value="@parentItem.Id">
                                                @(parentItem.Translations.FirstOrDefault()?.Title ?? parentItem.Title ??
                                                                                            $"Item {parentItem.Id}")
                                            </option>
                                        }
                                    </select>
                                    <p class="mt-1 text-sm text-gray-500">Select a parent item to create a nested
                                        structure</p>
                                    <span asp-validation-for="ParentSectionItemId" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="SortOrder" class="block text-sm font-medium text-gray-700 mb-2">Sort
                                        Order</label>
                                    <input asp-for="SortOrder"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                        type="number" value="0" />
                                    <p class="mt-1 text-sm text-gray-500">Lower numbers appear first</p>
                                    <span asp-validation-for="SortOrder" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="Key"
                                        class="block text-sm font-medium text-gray-700 mb-2">Key</label>
                                    <input asp-for="Key"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Unique key for this item" />
                                    <p class="mt-1 text-sm text-gray-500">Optional unique identifier</p>
                                    <span asp-validation-for="Key" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="IconClass" class="block text-sm font-medium text-gray-700 mb-2">Icon
                                        Class</label>
                                    <input asp-for="IconClass"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="e.g., fas fa-home" />
                                    <p class="mt-1 text-sm text-gray-500">FontAwesome icon class (optional)</p>
                                    <span asp-validation-for="IconClass" class="text-red-600 text-sm"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Settings -->
                        <div class="space-y-6">
                            <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                                <div class="px-6 py-4 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">Settings</h3>
                                </div>
                                <div class="p-6 space-y-6">
                                    <div class="flex items-start">
                                        <input asp-for="AllowReorder"
                                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mt-1"
                                            type="checkbox" checked />
                                        <div class="ml-3">
                                            <label asp-for="AllowReorder" class="text-sm font-medium text-gray-700">
                                                Allow Reorder
                                            </label>
                                            <p class="text-sm text-gray-500">Allow this item to be reordered in the UI
                                            </p>
                                        </div>
                                    </div>

                                    <div class="flex items-start">
                                        <input asp-for="AllowRemove"
                                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mt-1"
                                            type="checkbox" checked />
                                        <div class="ml-3">
                                            <label asp-for="AllowRemove" class="text-sm font-medium text-gray-700">
                                                Allow Remove
                                            </label>
                                            <p class="text-sm text-gray-500">Allow this item to be removed from the UI
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Template Preview -->
                            <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                                <div class="px-6 py-4 border-b border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-900">Template Preview</h3>
                                </div>
                                <div class="p-6">
                                    <div id="templatePreview" class="text-center py-4">
                                        <i class="fas fa-info-circle text-gray-400 text-2xl mb-2"></i>
                                        <p class="text-gray-500">Select a template to see its configuration</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Translations -->
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Translations</h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                @for (int i = 0; i < Model.Translations.Count; i++)
                                {
                                    var translation = Model.Translations[i];
                                    var language = availableLanguages.FirstOrDefault(l => l.Id == translation.LanguageId);

                                    <div class="border border-gray-200 rounded-lg">
                                        <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                                            <h4 class="text-sm font-medium text-gray-900 flex items-center">
                                                <i class="fas fa-language text-blue-600 mr-2"></i>
                                                @(language?.Name ?? "Unknown Language")
                                                <span class="ml-2 text-xs text-gray-500">(@(language?.Code ?? "N/A"))</span>
                                            </h4>
                                        </div>
                                        <div class="p-4 space-y-4">
                                            <input type="hidden" asp-for="Translations[i].Id" />
                                            <input type="hidden" asp-for="Translations[i].SectionItemId" />
                                            <input type="hidden" asp-for="Translations[i].LanguageId" />

                                            <div>
                                                <label asp-for="Translations[i].Title"
                                                    class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                                <input asp-for="Translations[i].Title"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                                    placeholder="Enter title in @(language?.Name ?? "this language")" />
                                                <span asp-validation-for="Translations[i].Title"
                                                    class="text-red-600 text-sm"></span>
                                            </div>

                                            <div>
                                                <label asp-for="Translations[i].Description"
                                                    class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                                <textarea asp-for="Translations[i].Description"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                                rows="3"
                                                placeholder="Enter description in @(language?.Name ?? "this language")"></textarea>
                                                <span asp-validation-for="Translations[i].Description"
                                                    class="text-red-600 text-sm"></span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="px-6 py-4">
                            <div class="flex justify-between">
                                <a href="@Url.Action("SectionItems", "Content")"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i class="fas fa-arrow-left mr-2"></i>
                                    Back to List
                                </a>
                                <button type="submit"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i class="fas fa-save mr-2"></i>
                                    Create Section Item
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Template selection change handler
            const templateSelect = document.getElementById('TemplateId');
            const previewDiv = document.getElementById('templatePreview');

            if (templateSelect) {
                templateSelect.addEventListener('change', function () {
                    const templateId = this.value;

                    if (templateId) {
                        // This would typically make an AJAX call to get template details
                        previewDiv.innerHTML = `
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center">
                                    <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                                    <span class="text-blue-800">Template selected. Field definitions will be loaded after creation.</span>
                                </div>
                            `;
                    } else {
                        previewDiv.innerHTML = `
                                <div class="text-center py-4">
                                    <i class="fas fa-info-circle text-gray-400 text-2xl mb-2"></i>
                                    <p class="text-gray-500">Select a template to see its configuration</p>
                                </div>
                            `;
                    }
                });
            }

            // Form validation
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function (e) {
                    const type = document.getElementById('Type').value;
                    const mediaType = document.getElementById('MediaType').value;

                    if (!type || !mediaType) {
                        e.preventDefault();

                        // Show error message with Tailwind styling
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-center';
                        errorDiv.innerHTML = `
                                <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                                <span class="text-red-800">Please select both Type and Media Type.</span>
                                <button type="button" class="ml-auto text-red-600 hover:text-red-800" onclick="this.parentElement.remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;

                        // Insert error message at the top of the form
                        const formContainer = form.parentElement;
                        formContainer.insertBefore(errorDiv, form);

                        return false;
                    }
                });
            }

            // Add smooth transitions to form elements
            const formElements = document.querySelectorAll('input, select, textarea');
            formElements.forEach(element => {
                element.addEventListener('focus', function () {
                    this.classList.add('ring-2', 'ring-blue-500', 'border-blue-500');
                });
                element.addEventListener('blur', function () {
                    this.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
                });
            });
        });
    </script>
}
