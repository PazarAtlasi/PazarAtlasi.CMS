@using PazarAtlasi.CMS.Application.Dtos
@using PazarAtlasi.CMS.Models.ViewModels
@model PazarAtlasi.CMS.Application.Dtos.SectionItemUpdateDto

@{
    ViewData["Title"] = Model.Id > 0 ? "Edit Section Item" : "Create Section Item";
    var availableLanguages = ViewBag.Languages as List<LanguageViewModel>;
}

<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center">
                    <i class="fas fa-edit text-blue-600 mr-3 text-xl"></i>
                    <h1 class="text-2xl font-bold text-gray-900">
                        @(Model.Id > 0 ? "Edit Section Item" : "Create Section Item")
                    </h1>
                </div>
            </div>

            <div class="p-6">
                <!-- Error Message -->
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-center">
                        <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                        <span class="text-red-800">@TempData["ErrorMessage"]</span>
                        <button type="button" class="ml-auto text-red-600 hover:text-red-800" onclick="this.parentElement.style.display='none'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                }

                <form asp-action="@(Model.Id > 0 ? "SectionItemEdit" : "SectionItemCreate")" method="post" class="space-y-8">
                    @if (Model.Id > 0)
                    {
                        <input type="hidden" asp-for="Id" />
                    }

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Basic Information -->
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900">Basic Information</h3>
                            </div>
                            <div class="p-6 space-y-6">
                                <div>
                                    <label asp-for="Type" class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                    <select asp-for="Type" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" asp-items="@(new SelectList(ViewBag.SectionItemTypes))">
                                        <option value="">Select Type</option>
                                    </select>
                                    <span asp-validation-for="Type" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="MediaType" class="block text-sm font-medium text-gray-700 mb-2">Media Type</label>
                                    <select asp-for="MediaType" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" asp-items="@(new SelectList(ViewBag.MediaTypes))">
                                        <option value="">Select Media Type</option>
                                    </select>
                                    <span asp-validation-for="MediaType" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="TemplateId" class="block text-sm font-medium text-gray-700 mb-2">Template</label>
                                    <select asp-for="TemplateId" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">No Template</option>
                                        @foreach (var template in ViewBag.Templates != null ? ViewBag.Templates as List<TemplateDto> : new List<TemplateDto>())
                                        {
                                            <option value="@template.Id" selected="@(Model.TemplateId == template.Id)">
                                                @(template.Translations.FirstOrDefault()?.Name ?? template.TemplateKey)
                                            </option>
                                        }
                                    </select>
                                    <span asp-validation-for="TemplateId" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="ParentSectionItemId" class="block text-sm font-medium text-gray-700 mb-2">Parent Section Item</label>
                                    <select asp-for="ParentSectionItemId" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">No Parent (Root Item)</option>
                                        @foreach (var parentItem in ViewBag.ParentSectionItems as List<SectionItemViewModel>)
                                        {
                                            <option value="@parentItem.Id" selected="@(Model.ParentSectionItemId == parentItem.Id)">
                                                @(parentItem.Translations.FirstOrDefault()?.Title ?? parentItem.Title ?? $"Item {parentItem.Id}")
                                            </option>
                                        }
                                    </select>
                                    <span asp-validation-for="ParentSectionItemId" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="SortOrder" class="block text-sm font-medium text-gray-700 mb-2">Sort Order</label>
                                    <input asp-for="SortOrder" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" type="number" />
                                    <span asp-validation-for="SortOrder" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="Key" class="block text-sm font-medium text-gray-700 mb-2">Key</label>
                                    <input asp-for="Key" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Unique key for this item" />
                                    <span asp-validation-for="Key" class="text-red-600 text-sm"></span>
                                </div>

                                <div>
                                    <label asp-for="IconClass" class="block text-sm font-medium text-gray-700 mb-2">Icon Class</label>
                                    <input asp-for="IconClass" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., fas fa-home" />
                                    <span asp-validation-for="IconClass" class="text-red-600 text-sm"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Settings -->
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900">Settings</h3>
                            </div>
                            <div class="p-6 space-y-6">
                                <div class="flex items-center">
                                    <input asp-for="AllowReorder" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" type="checkbox" />
                                    <label asp-for="AllowReorder" class="ml-3 text-sm font-medium text-gray-700">
                                        Allow Reorder
                                    </label>
                                </div>

                                <div class="flex items-center">
                                    <input asp-for="AllowRemove" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" type="checkbox" />
                                    <label asp-for="AllowRemove" class="ml-3 text-sm font-medium text-gray-700">
                                        Allow Remove
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Translations -->
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Translations</h3>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                @for (int i = 0; i < Model.Translations.Count; i++)
                                {
                                    var translation = Model.Translations[i];
                                    var language = availableLanguages.FirstOrDefault(l => l.Id == (translation?.LanguageId ?? 1));
                                    
                                    <div class="border border-gray-200 rounded-lg">
                                        <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                                            <h4 class="text-sm font-medium text-gray-900 flex items-center">
                                                <i class="fas fa-language text-blue-600 mr-2"></i>
                                                @(language?.Name ?? "Unknown Language")
                                                <span class="ml-2 text-xs text-gray-500">(@(language?.Code ?? "N/A"))</span>
                                            </h4>
                                        </div>
                                        <div class="p-4 space-y-4">
                                            <input type="hidden" asp-for="Translations[i].Id" />
                                            <input type="hidden" asp-for="Translations[i].SectionItemId" />
                                            <input type="hidden" asp-for="Translations[i].LanguageId" />

                                            <div>
                                                <label asp-for="Translations[i].Title" class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                                <input asp-for="Translations[i].Title" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter title in @(language?.Name ?? "this language")" />
                                                <span asp-validation-for="Translations[i].Title" class="text-red-600 text-sm"></span>
                                            </div>

                                            <div>
                                                <label asp-for="Translations[i].Description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                                <textarea asp-for="Translations[i].Description" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Enter description in @(language?.Name ?? "this language")"></textarea>
                                                <span asp-validation-for="Translations[i].Description" class="text-red-600 text-sm"></span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Fields Section -->
                    @if (Model.Fields.Any())
                    {
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="text-lg font-medium text-gray-900">Fields</h3>
                                <button type="button" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" onclick="addField()">
                                    <i class="fas fa-plus mr-2"></i>
                                    Add Field
                                </button>
                            </div>
                            <div class="p-6">
                                <div id="fieldsContainer" class="space-y-4">
                                    @for (int i = 0; i < Model.Fields.Count; i++)
                                    {
                                        await Html.RenderPartialAsync("_SectionItemDetailField", Model.Fields[i], new ViewDataDictionary(ViewData) { { "FieldIndex", i } });
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Field Values Section -->
                    @if (Model.FieldValues.Any())
                    {
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900">Field Values</h3>
                            </div>
                            <div class="p-6">
                                <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                                    <table class="min-w-full divide-y divide-gray-300">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Field</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Translations</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            @for (int i = 0; i < Model.FieldValues.Count; i++)
                                            {
                                                var fieldValue = Model.FieldValues[i];
                                                var field = Model.Fields.FirstOrDefault(f => f.Id == fieldValue.SectionItemFieldId);
                                                
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="text-sm font-medium text-gray-900">@(field?.FieldName ?? "Unknown Field")</div>
                                                        <div class="text-sm text-gray-500">@(field?.FieldKey ?? "N/A")</div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <input asp-for="FieldValues[i].Value" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
                                                        <input type="hidden" asp-for="FieldValues[i].Id" />
                                                        <input type="hidden" asp-for="FieldValues[i].SectionId" />
                                                        <input type="hidden" asp-for="FieldValues[i].SectionItemId" />
                                                        <input type="hidden" asp-for="FieldValues[i].SectionItemFieldId" />
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                            @fieldValue.Translations.Count translations
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <button type="button" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" onclick="removeFieldValue(@i)">
                                                            <i class="fas fa-trash mr-1"></i>
                                                            Remove
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Form Actions -->
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="px-6 py-4">
                            <div class="flex justify-between">
                                <a href="@Url.Action("SectionItems", "Content")" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i class="fas fa-arrow-left mr-2"></i>
                                    Back to List
                                </a>
                                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i class="fas fa-save mr-2"></i>
                                    @(Model.Id > 0 ? "Update" : "Create") Section Item
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function addField() {
            // This would typically add a new field to the form
            // Implementation depends on the specific requirements
            console.log('Add field functionality would be implemented here');
        }

        function removeFieldValue(index) {
            // This would typically remove a field value from the form
            // Implementation depends on the specific requirements
            console.log('Remove field value functionality would be implemented here for index:', index);
        }

        // Form validation and enhancement
        document.addEventListener('DOMContentLoaded', function() {
            // Add smooth transitions to form elements
            const formElements = document.querySelectorAll('input, select, textarea');
            formElements.forEach(element => {
                element.addEventListener('focus', function() {
                    this.classList.add('ring-2', 'ring-blue-500', 'border-blue-500');
                });
                element.addEventListener('blur', function() {
                    this.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
                });
            });

            // Template selection change handler
            const templateSelect = document.getElementById('TemplateId');
            if (templateSelect) {
                templateSelect.addEventListener('change', function() {
                    const templateId = this.value;
                    // This would typically make an AJAX call to get template details
                    console.log('Template selected:', templateId);
                });
            }
        });
    </script>
}
