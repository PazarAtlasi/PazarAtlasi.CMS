@model PazarAtlasi.CMS.Models.ViewModels.AgentCreateEditViewModel
@using PazarAtlasi.CMS.Domain.Enums

@{
    ViewData["Title"] = "Edit Agent";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
    <!-- Back Navigation -->
    <div class="max-w-7xl mx-auto px-4 py-4">
        <a href="@Url.Action("Manage")"
            class="inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Manage Agents
        </a>
    </div>

    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <h1 class="text-4xl font-bold text-slate-900 mb-2">
                <i class="fas fa-edit text-blue-600 mr-3"></i>
                Edit Agent
            </h1>
            <p class="text-lg text-slate-600">Update agent information and configuration</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <form asp-action="Edit" method="post" class="space-y-8">
            <div asp-validation-summary="ModelOnly" class="text-red-600"></div>
            <input asp-for="Id" type="hidden" />

            <!-- Basic Information -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-xl font-semibold text-slate-900 mb-6">Basic Information</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label asp-for="Name" class="block text-sm font-medium text-slate-700 mb-2">Agent Name</label>
                        <input asp-for="Name"
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="e.g., Reporting Agent">
                        <span asp-validation-for="Name" class="text-red-600 text-sm"></span>
                    </div>

                    <div>
                        <label asp-for="Version" class="block text-sm font-medium text-slate-700 mb-2">Version</label>
                        <input asp-for="Version"
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="1.0.0">
                        <span asp-validation-for="Version" class="text-red-600 text-sm"></span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <div>
                        <label asp-for="Type" class="block text-sm font-medium text-slate-700 mb-2">Agent Type</label>
                        <select asp-for="Type" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Type</option>
                            @foreach (var agentType in Model.AvailableAgentTypes)
                            {
                                <option value="@((int)agentType.Value)" selected="@(Model.Type == agentType.Value ? "selected" : "")">@agentType.DisplayName</option>
                            }
                        </select>
                        <span asp-validation-for="Type" class="text-red-600 text-sm"></span>
                    </div>

                    <div>
                        <label asp-for="Category" class="block text-sm font-medium text-slate-700 mb-2">Category</label>
                        <select asp-for="Category" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Category</option>
                            @foreach (var category in Model.AvailableAgentCategories)
                            {
                                <option value="@((int)category.Value)" selected="@(Model.Category == category.Value ? "selected" : "")">@category.DisplayName</option>
                            }
                        </select>
                        <span asp-validation-for="Category" class="text-red-600 text-sm"></span>
                    </div>

                    <div>
                        <label asp-for="ExecutionType" class="block text-sm font-medium text-slate-700 mb-2">Execution Type</label>
                        <select asp-for="ExecutionType" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Execution Type</option>
                            @foreach (var executionType in Model.AvailableExecutionTypes)
                            {
                                <option value="@((int)executionType.Value)" selected="@(Model.ExecutionType == executionType.Value ? "selected" : "")">@executionType.DisplayName</option>
                            }
                        </select>
                        <span asp-validation-for="ExecutionType" class="text-red-600 text-sm"></span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label asp-for="IconClass" class="block text-sm font-medium text-slate-700 mb-2">Icon Class</label>
                        <input asp-for="IconClass"
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="fas fa-robot">
                        <span asp-validation-for="IconClass" class="text-red-600 text-sm"></span>
                        <p class="text-xs text-slate-500 mt-1">Use FontAwesome icon classes (e.g., fas fa-robot)</p>
                    </div>
                </div>

                <div class="mt-6">
                    <label asp-for="Description" class="block text-sm font-medium text-slate-700 mb-2">Short
                        Description</label>
                    <textarea asp-for="Description" rows="3"
                        class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Brief description of what this agent does..."></textarea>
                    <span asp-validation-for="Description" class="text-red-600 text-sm"></span>
                </div>

                <div class="mt-6">
                    <label asp-for="DetailedDescription" class="block text-sm font-medium text-slate-700 mb-2">Detailed
                        Description</label>
                    <textarea asp-for="DetailedDescription" rows="6"
                        class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Detailed explanation of the agent's capabilities, use cases, and benefits..."></textarea>
                    <span asp-validation-for="DetailedDescription" class="text-red-600 text-sm"></span>
                </div>

                <div class="mt-6">
                    <label asp-for="ImageUrl" class="block text-sm font-medium text-slate-700 mb-2">Image URL
                        (Optional)</label>
                    <input asp-for="ImageUrl" type="url"
                        class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="https://example.com/agent-image.png">
                    <span asp-validation-for="ImageUrl" class="text-red-600 text-sm"></span>
                </div>
            </div>

            <!-- Settings -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-xl font-semibold text-slate-900 mb-6">Settings</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label asp-for="SortOrder" class="block text-sm font-medium text-slate-700 mb-2">Sort
                            Order</label>
                        <input asp-for="SortOrder" type="number"
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="0">
                        <span asp-validation-for="SortOrder" class="text-red-600 text-sm"></span>
                        <p class="text-xs text-slate-500 mt-1">Lower numbers appear first</p>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-center">
                            <input asp-for="IsActive" type="checkbox"
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-300 rounded">
                            <label asp-for="IsActive" class="ml-2 block text-sm text-slate-700">Active</label>
                        </div>

                        <div class="flex items-center">
                            <input asp-for="IsFeatured" type="checkbox"
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-300 rounded">
                            <label asp-for="IsFeatured" class="ml-2 block text-sm text-slate-700">Featured</label>
                        </div>

                        <div class="flex items-center">
                            <input asp-for="IsPublic" type="checkbox"
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-300 rounded">
                            <label asp-for="IsPublic" class="ml-2 block text-sm text-slate-700">Public</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Integrations -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-xl font-semibold text-slate-900 mb-6">Integrations</h2>

                <div id="integrations-container">
                    @if (Model.Integrations != null && Model.Integrations.Any())
                    {
                        @for (int i = 0; i < Model.Integrations.Count; i++)
                        {
                            <div class="integration-item border border-slate-200 rounded-lg p-4 mb-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-medium text-slate-900">Integration #@(i + 1)</h3>
                                    <button type="button" class="text-red-600 hover:text-red-800 remove-integration">
                                        <i class="fas fa-trash mr-1"></i>Remove
                                    </button>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Integration Name</label>
                                        <input asp-for="Integrations[i].Name"
                                            class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="e.g., Report Generator Workflow">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Integration Type</label>
                                        <select asp-for="Integrations[i].Type"
                                            class="integration-type w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Select Type</option>
                                            @foreach (var integrationType in Model.AvailableIntegrationTypes)
                                            {
                                                <option value="@((int)integrationType.Value)" selected="@(Model.Integrations[i].Type == integrationType.Value ? "selected" : "")">@integrationType.DisplayName</option>
                                            }
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Trigger Type</label>
                                        <select asp-for="Integrations[i].TriggerType"
                                            class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            @foreach (var triggerType in Model.AvailableIntegrationTriggers)
                                            {
                                                <option value="@((int)triggerType.Value)" selected="@(Model.Integrations[i].TriggerType == triggerType.Value ? "selected" : "")">@triggerType.DisplayName</option>
                                            }
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-2">Priority</label>
                                        <input asp-for="Integrations[i].Priority" type="number"
                                            class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            value="1" min="1">
                                    </div>
                                </div>

                                <!-- Dynamic Configuration Area -->
                                <div class="mt-4 integration-config-area">
                                    <!-- Configuration will be dynamically loaded here -->
                                </div>

                                <div class="mt-4">
                                    <div class="flex items-center">
                                        <input type="hidden" asp-for="Integrations[i].IsActive" value="false">
                                        <input asp-for="Integrations[i].IsActive" type="checkbox" value="true"
                                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-300 rounded">
                                        <label class="ml-2 block text-sm text-slate-700">Active</label>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                    <!-- Integration Template (Hidden) -->
                    <div id="integration-template" class="integration-item border border-slate-200 rounded-lg p-4 mb-4"
                        style="display: none;">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-medium text-slate-900">Integration #<span
                                    class="integration-number">1</span></h3>
                            <button type="button" class="text-red-600 hover:text-red-800 remove-integration">
                                <i class="fas fa-trash mr-1"></i>Remove
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Integration Name</label>
                                <input type="text" name="Integrations[INDEX].Name"
                                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="e.g., Report Generator Workflow">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Integration Type</label>
                                <select name="Integrations[INDEX].Type"
                                    class="integration-type w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select Type</option>
                                    @foreach (var integrationType in Model.AvailableIntegrationTypes)
                                    {
                                        <option value="@((int)integrationType.Value)">@integrationType.DisplayName</option>
                                    }
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Trigger Type</label>
                                <select name="Integrations[INDEX].TriggerType"
                                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    @foreach (var triggerType in Model.AvailableIntegrationTriggers)
                                    {
                                        <option value="@((int)triggerType.Value)">@triggerType.DisplayName</option>
                                    }
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Priority</label>
                                <input type="number" name="Integrations[INDEX].Priority"
                                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    value="1" min="1">
                            </div>
                        </div>

                        <!-- Dynamic Configuration Area -->
                        <div class="mt-4 integration-config-area">
                            <!-- Configuration will be dynamically loaded here -->
                        </div>

                        <div class="mt-4">
                            <div class="flex items-center">
                                <input type="hidden" name="Integrations[INDEX].IsActive" value="false">
                                <input type="checkbox" name="Integrations[INDEX].IsActive" value="true"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-300 rounded" checked>
                                <label class="ml-2 block text-sm text-slate-700">Active</label>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" id="add-integration"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Integration
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-between pt-6">
                <a href="@Url.Action("Manage")"
                    class="px-6 py-3 text-slate-600 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
                    Cancel
                </a>
                <div class="space-x-3">
                    <button type="submit" name="status" value="Draft"
                        class="px-6 py-3 text-slate-700 bg-slate-100 border border-slate-300 rounded-lg hover:bg-slate-200 transition-colors">
                        Save as Draft
                    </button>
                    <button type="submit" name="status" value="Active"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Update & Activate
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let integrationCounter = @(Model.Integrations?.Count ?? 0);

        // Integration configuration templates
        const integrationConfigs = {
            '1': { // N8n
                title: 'N8n Workflow Configuration',
                fields: [
                    {
                        name: 'workflowId',
                        label: 'Workflow ID',
                        type: 'text',
                        placeholder: 'e.g., report_generator_001',
                        required: true,
                        help: 'Unique identifier for your n8n workflow'
                    },
                    {
                        name: 'webhookUrl',
                        label: 'Webhook URL',
                        type: 'url',
                        placeholder: 'https://n8n.example.com/webhook/your-webhook',
                        required: true,
                        help: 'The webhook URL from your n8n workflow'
                    },
                    {
                        name: 'httpMethod',
                        label: 'HTTP Method',
                        type: 'select',
                        options: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
                        default: 'POST',
                        help: 'HTTP method for webhook calls'
                    },
                    {
                        name: 'timeout',
                        label: 'Timeout (ms)',
                        type: 'number',
                        default: 30000,
                        help: 'Request timeout in milliseconds'
                    },
                    {
                        name: 'retryCount',
                        label: 'Retry Count',
                        type: 'number',
                        default: 3,
                        help: 'Number of retry attempts on failure'
                    },
                    {
                        name: 'authentication',
                        label: 'Authentication',
                        type: 'select',
                        options: ['none', 'basic', 'bearer', 'apikey'],
                        default: 'none',
                        help: 'Authentication method'
                    },
                    {
                        name: 'authToken',
                        label: 'Auth Token/API Key',
                        type: 'password',
                        placeholder: 'Enter your authentication token',
                        help: 'Authentication token or API key (if required)',
                        showWhen: 'authentication != none'
                    }
                ]
            },
            '2': { // CustomAPI
                title: 'Custom API Configuration',
                fields: [
                    {
                        name: 'endpoint',
                        label: 'API Endpoint',
                        type: 'url',
                        placeholder: 'https://api.example.com/process',
                        required: true,
                        help: 'Full URL of your API endpoint'
                    },
                    {
                        name: 'method',
                        label: 'HTTP Method',
                        type: 'select',
                        options: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
                        default: 'POST',
                        help: 'HTTP method for API calls'
                    },
                    {
                        name: 'timeout',
                        label: 'Timeout (ms)',
                        type: 'number',
                        default: 30000,
                        help: 'Request timeout in milliseconds'
                    },
                    {
                        name: 'headers',
                        label: 'Custom Headers',
                        type: 'textarea',
                        placeholder: '{"Authorization": "Bearer token", "X-Custom-Header": "value"}',
                        help: 'Additional headers as JSON object'
                    }
                ]
            },
            '3': { // Webhook
                title: 'Webhook Configuration',
                fields: [
                    {
                        name: 'url',
                        label: 'Webhook URL',
                        type: 'url',
                        placeholder: 'https://hooks.example.com/webhook',
                        required: true,
                        help: 'URL where webhook notifications will be sent'
                    },
                    {
                        name: 'secret',
                        label: 'Webhook Secret',
                        type: 'password',
                        placeholder: 'Enter webhook secret for verification',
                        help: 'Secret key for webhook signature verification'
                    },
                    {
                        name: 'events',
                        label: 'Trigger Events',
                        type: 'multiselect',
                        options: ['agent.executed', 'agent.failed', 'agent.started', 'subscription.created', 'usage.limit.reached'],
                        help: 'Events that will trigger this webhook'
                    }
                ]
            },
            '4': { // Internal
                title: 'Internal Service Configuration',
                fields: [
                    {
                        name: 'serviceName',
                        label: 'Service Name',
                        type: 'text',
                        placeholder: 'e.g., ReportingService',
                        required: true,
                        help: 'Name of the internal service class'
                    },
                    {
                        name: 'methodName',
                        label: 'Method Name',
                        type: 'text',
                        placeholder: 'e.g., GenerateReport',
                        required: true,
                        help: 'Method to call on the service'
                    },
                    {
                        name: 'parameters',
                        label: 'Default Parameters',
                        type: 'textarea',
                        placeholder: '{"format": "pdf", "template": "default"}',
                        help: 'Default parameters as JSON object'
                    }
                ]
            }
        };

        // Add integration functionality
        document.getElementById('add-integration').addEventListener('click', function () {
            const template = document.getElementById('integration-template');
            const container = document.getElementById('integrations-container');
            const clone = template.cloneNode(true);

            clone.id = '';
            clone.style.display = 'block';
            clone.querySelector('.integration-number').textContent = integrationCounter + 1;

            // Update all name attributes
            const inputs = clone.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.name) {
                    input.name = input.name.replace('[INDEX]', `[${integrationCounter}]`);
                }
            });

            // Add remove functionality
            clone.querySelector('.remove-integration').addEventListener('click', function () {
                clone.remove();
            });

            // Add integration type change handler
            const typeSelect = clone.querySelector('.integration-type');
            typeSelect.addEventListener('change', function () {
                loadIntegrationConfig(this.value, clone.querySelector('.integration-config-area'), integrationCounter);
            });

            container.appendChild(clone);
            integrationCounter++;
        });

        // Remove integration functionality for existing items
        document.querySelectorAll('.remove-integration').forEach(button => {
            button.addEventListener('click', function () {
                button.closest('.integration-item').remove();
            });
        });

        // Integration type change handlers for existing items
        document.querySelectorAll('.integration-type').forEach(select => {
            select.addEventListener('change', function () {
                const integrationItem = this.closest('.integration-item');
                const configArea = integrationItem.querySelector('.integration-config-area');
                const index = Array.from(integrationItem.parentNode.children).indexOf(integrationItem);
                loadIntegrationConfig(this.value, configArea, index);
            });

            // Load existing configuration on page load
            if (select.value) {
                const integrationItem = select.closest('.integration-item');
                const configArea = integrationItem.querySelector('.integration-config-area');
                const index = Array.from(integrationItem.parentNode.children).indexOf(integrationItem);
                loadIntegrationConfig(select.value, configArea, index);
            }
        });

        // Load integration configuration
        function loadIntegrationConfig(integrationType, container, index) {
            if (!integrationType || !integrationConfigs[integrationType]) {
                container.innerHTML = '';
                return;
            }

            const config = integrationConfigs[integrationType];
            container.innerHTML = `
                        <h4 class="font-medium text-slate-900 mb-3">${config.title}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${config.fields.map(field => generateFieldHTML(field, index)).join('')}
                        </div>
                    `;
        }

        // Generate field HTML
        function generateFieldHTML(field, index) {
            let input = '';
            const fieldName = `Integrations[${index}].ConfigurationJson.${field.name}`;

            switch (field.type) {
                case 'select':
                    input = `<select name="${fieldName}" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                ${field.options.map(option => `<option value="${option}" ${field.default === option ? 'selected' : ''}>${option}</option>`).join('')}
                            </select>`;
                    break;
                case 'textarea':
                    input = `<textarea name="${fieldName}" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="${field.placeholder || ''}">${field.default || ''}</textarea>`;
                    break;
                case 'number':
                    input = `<input type="number" name="${fieldName}" value="${field.default || ''}" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="${field.placeholder || ''}">`;
                    break;
                default:
                    input = `<input type="${field.type}" name="${fieldName}" value="${field.default || ''}" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>`;
            }

            return `
                        <div ${field.showWhen ? `data-show-when="${field.showWhen}"` : ''}>
                            <label class="block text-sm font-medium text-slate-700 mb-2">${field.label}</label>
                            ${input}
                            ${field.help ? `<p class="text-xs text-slate-500 mt-1">${field.help}</p>` : ''}
                        </div>
                    `;
        }

        // Add conditional field logic
        function addConditionalFieldLogic(container) {
            const conditionalFields = container.querySelectorAll('[data-show-when]');

            conditionalFields.forEach(field => {
                const condition = field.getAttribute('data-show-when');
                const [conditionField, conditionValue] = condition.split(' != ');

                // Find the field that controls visibility
                const controlField = container.querySelector(`[name*="${conditionField}"]`);
                if (controlField) {
                    controlField.addEventListener('change', function () {
                        const shouldShow = this.value !== conditionValue;
                        field.style.display = shouldShow ? 'block' : 'none';
                    });

                    // Initial state
                    const shouldShow = controlField.value !== conditionValue;
                    field.style.display = shouldShow ? 'block' : 'none';
                }
            });
        }
    </script>
}
